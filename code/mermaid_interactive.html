<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to Mermaid Flowchart</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
        window.mermaid = mermaid;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .templates-dropdown {
            position: relative;
        }
        .templates-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
            margin-top: 5px;
        }
        .templates-menu.show {
            display: block;
        }
        .template-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }
        .template-item:last-child {
            border-bottom: none;
        }
        .template-item:hover {
            background: #f8f9fa;
        }
        .template-item strong {
            display: block;
            color: #495057;
            margin-bottom: 4px;
        }
        .template-item span {
            font-size: 12px;
            color: #6c757d;
        }
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-weight: 600;
            font-size: 12px;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        select, input[type="file"] {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: white;
        }
        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        
        /* DIAGRAM SECTION - NOW AT TOP */
        .diagram-section {
            padding: 30px;
            background: #f8f9fb;
            border-bottom: 2px solid #e9ecef;
        }
        .diagram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h2 {
            color: #495057;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .zoom-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .export-dropdown {
            position: relative;
        }
        .export-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            margin-top: 5px;
        }
        .export-menu.show {
            display: block;
        }
        .export-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-item:last-child {
            border-bottom: none;
        }
        .export-item:hover {
            background: #f8f9fa;
        }
        .zoom-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .zoom-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        #diagram {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            cursor: grab;
        }
        #diagram.panning {
            cursor: grabbing;
        }
        #diagramContainer {
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }
        #diagram svg {
            max-width: 100%;
            height: auto;
        }
        .info-panel {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-left: 4px solid #2196F3;
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .info-panel.show {
            display: block;
        }
        .info-panel h3 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .info-panel a {
            color: #1976D2;
            text-decoration: none;
            font-weight: 600;
        }
        .info-panel a:hover {
            text-decoration: underline;
        }
        
        /* DATA SECTION - NOW BELOW */
        .data-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        .section {
            padding: 30px;
            overflow: auto;
            max-height: 500px;
        }
        .section:first-child {
            border-right: 2px solid #e9ecef;
            background: #fafbfc;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #csvTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #csvTable th, #csvTable td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        #csvTable th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        #csvTable tr:hover {
            background: #f8f9fa;
        }
        #csvTable tbody tr:last-child td {
            border-bottom: none;
        }
        #mermaidCode {
            width: 100%;
            min-height: 350px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Courier New', Monaco, monospace;
            font-size: 13px;
            resize: vertical;
            background: #f8f9fa;
            line-height: 1.5;
        }
        #mermaidCode:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        .code-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #28a745;
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .error-badge {
            background: #dc3545;
        }
        .node-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @media (max-width: 1024px) {
            .data-section {
                grid-template-columns: 1fr;
            }
            .section:first-child {
                border-right: none;
                border-bottom: 2px solid #e9ecef;
            }
        }
        .grid {
                display: grid;
                /* Define two columns: one for the main card, one for the sidebar */
                grid-template-columns: 3fr 1fr; /* Example ratio: 75% for main, 25% for side */
                gap: 1.5rem; /* Space between columns */
                /* Ensure the grid container can fill the screen height if needed */
                height: 100%;
            }

            .card {
                display: flex; /* Make the card a flex container */
                flex-direction: column; /* Stack items vertically */
                height: 100%; /* Ensure the card takes full height of its grid cell */
            }

            /* New style for the iframe container to manage its size */
            .box.full.iframe-container {
                flex-grow: 1; /* This makes the iframe container take up all available vertical space */
                min-height: 400px; /* Ensure a minimum height if the main card is too short */
                display: flex; /* Make it a flex container to manage the iframe inside */
            }

            .box.full.iframe-container iframe {
                flex-grow: 1; /* The iframe will expand to fill the container */
                height: 100%; /* Ensures the iframe uses the full height assigned by flex-grow */
            }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä CSV to Mermaid Flowchart</h1>
            <p class="subtitle">Transform your data into interactive diagrams</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="theme">Theme</label>
                    <select id="theme">
                        <option value="default">Default</option>
                        <option value="dark">Dark</option>
                        <option value="neutral">Neutral</option>
                        <option value="forest">Forest</option>
                    </select>
                </div>
                <div class="control-item">
                    <label for="direction">Direction</label>
                    <select id="direction">
                        <option value="TD">Top ‚Üí Bottom</option>
                        <option value="LR">Left ‚Üí Right</option>
                        <option value="BT">Bottom ‚Üí Top</option>
                        <option value="RL">Right ‚Üí Left</option>
                    </select>
                </div>
                <div class="control-item">
                    <label for="csvFile">Upload CSV</label>
                    <input type="file" id="csvFile" accept=".csv">
                </div>
            </div>
            <div class="button-group">
                <div class="templates-dropdown">
                    <button class="btn-primary" onclick="toggleTemplates()">üìã Templates</button>
                    <div id="templatesMenu" class="templates-menu">
                        <div class="template-item" onclick="loadTemplate('project')">
                            <strong>Project Workflow</strong>
                            <span>Start ‚Üí Develop ‚Üí Test ‚Üí Deploy</span>
                        </div>
                        <div class="template-item" onclick="loadTemplate('decision')">
                            <strong>Decision Tree</strong>
                            <span>Conditional logic flow</span>
                        </div>
                        <div class="template-item" onclick="loadTemplate('process')">
                            <strong>Business Process</strong>
                            <span>Multi-department workflow</span>
                        </div>
                        <div class="template-item" onclick="loadTemplate('onboarding')">
                            <strong>Employee Onboarding</strong>
                            <span>HR process flow</span>
                        </div>
                        <div class="template-item" onclick="loadTemplate('sales')">
                            <strong>Sales Pipeline</strong>
                            <span>Lead ‚Üí Customer journey</span>
                        </div>
                    </div>
                </div>
                <button class="btn-primary" onclick="loadSampleData()">üìù Load Sample</button>
                <button class="btn-secondary" onclick="downloadTemplate()">‚¨áÔ∏è Download CSV Template</button>
                <button class="btn-success" onclick="renderDiagram()">üé® Render Diagram</button>
                <button class="btn-primary" onclick="generateLandingPage()">üè† Generate Landing Page</button>
            </div>
        </div>

        <!-- DIAGRAM SECTION - MOVED TO TOP -->
        <div class="diagram-section">
            <div class="diagram-header">
                <h2>üé® Interactive Diagram</h2>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomDiagram(0.8)">‚àí</button>
                    <button class="zoom-btn" onclick="zoomDiagram(1)">Reset</button>
                    <button class="zoom-btn" onclick="zoomDiagram(1.2)">+</button>
                    <span style="font-size: 12px; color: #6c757d; margin: 0 10px;">Pan: Click & Drag</span>
                    <div class="export-dropdown">
                        <button class="zoom-btn" onclick="toggleExport()">üíæ Export</button>
                        <div id="exportMenu" class="export-menu">
                            <div class="export-item" onclick="exportDiagram('png')">
                                üñºÔ∏è Export as PNG
                            </div>
                            <div class="export-item" onclick="exportDiagram('svg')">
                                üìê Export as SVG
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="diagram"></div>
            <div id="infoPanel" class="info-panel"></div>
        </div>
        
        <!-- Tooltip element -->
        <div id="nodeTooltip" class="node-tooltip"></div>

        <!-- DATA SECTION - MOVED BELOW -->
        <div class="data-section">
            <div class="section">
                <div class="section-header">
                    <h2>üìã CSV Data</h2>
                    <span class="status-badge" id="dataStatus">Ready</span>
                </div>
                <div>   
                    <small style="color: #6c757d;">Note that the URL, 
                        notes and tooltip are associated with the <strong>target node ("TO_ID")</strong> in each connection. 
                        <strong>To_Color</strong> takes precedence over <strong>From_Color</strong> when both exist for the same node.</small>
                </div>
                <div id="csvTableContainer">
                    <table id="csvTable"></table>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>üìù Mermaid Code</h2>
                    <span class="status-badge" id="codeStatus">Ready</span>
                </div>
                <div><small style="color: #6c757d;">Use the buttons below to update the diagram or copy the code to your clipboard.
                    The mermaid syntax can be explored at: 
                    <a href = "https://mermaid.js.org/syntax/flowchart.html" target="_blank">https://mermaid.js.org/syntax/flowchart.html</a>
                </small></div>
                <textarea id="mermaidCode" placeholder="Your Mermaid code will appear here..."></textarea>
                <div class="code-actions">
                    <button class="btn-primary" onclick="renderDiagram()">Update Diagram</button>
                    <button class="btn-secondary" onclick="copyCode()">Copy Code</button>
                    <button class="btn-secondary" onclick="undo()">‚Ü∂ Undo</button>
                    <button class="btn-secondary" onclick="redo()">‚Ü∑ Redo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let urlMap = {};
        let noteMap = {};
        let tooltipMap = {};
        let currentZoom = 1;
        let panX = 0;
        let panY = 0;
        let isPanning = false;
        let startPanX = 0;
        let startPanY = 0;
        
        // Undo/Redo functionality
        let codeHistory = [];
        let historyIndex = -1;
        const maxHistory = 50;

        const sampleData = [
            // Precedence: To_Color takes precedence over From_Color when both exist for the same node.
            //  Implementation detail: We collect fromColors and toColors while scanning rows, then build nodeStyles such that toColors overwrite fromColors.
            // [From_ID, From_Label, To_ID, To_Label, Connector, Tooltip, URL, notes, From_Color, To_Color]
            ['A', 'Project Start', 'B', 'Data Collection', '', 'Kickoff notes', '#', '', '#B8B8B8A', '#F8BBD0'],
            ['A', 'Project Start', 'C', 'Analysis', '-- some text -->', 'Define requirements', 'https://example.com/data', 'Note B', '#E3F2FD', '#B8B8B8'],
            ['C', 'Analysis', 'D', 'Review', '-.->',  'Check results', 'https://example.com/analysis', 'Note C', '', '#D1CFCF'],
            ['D', 'Review', 'E', 'Final Report', '<-->', 'Final sign-off', 'https://example.com/report', 'Note D', '', '#D1CFCF']
        ];

        // Template data
        const templates = {
            project: [
                ['A', 'Requirements', 'B', 'Design', '---', 'tooltip example', 'url goes here', 'notes can be added', '', '#E3F2FD'],
                ['B', 'Design', 'C', 'Development', '-->', '', '', '', '', '#FFF9C4'],
                ['C', 'Development', 'D', 'Testing', '-->', '', '', '', '', '#FFE0B2'],
                ['D', 'Testing', 'E', 'Deployment', '-->', '', '', '', '', '#C8E6C9'],
                ['E', 'Deployment', 'F', 'Maintenance', '-->', '', '', '', '', '#F8BBD0']
            ],
            decision: [
                ['A', 'Start', 'B', 'Check Input', '-->', '', '', '', '', '#E1F5FE'],
                ['B', 'Check Input', 'C', 'Valid?', '-->', '', '', '', '', '#FFF9C4'],
                ['C', 'Valid?', 'D', 'Process', '-->|Yes|', '', '', '', '', '#C8E6C9'],
                ['C', 'Valid?', 'E', 'Error', '-->|No|', '', '', '', '', '#FFCDD2'],
                ['D', 'Process', 'F', 'Success', '-->', '', '', '', '', '#C8E6C9'],
                ['E', 'Error', 'B', 'Check Input', '-.->|Retry|', '', '', '', '', '']
            ],
            process: [
                ['A', 'Customer Request', 'B', 'Sales Review', '-->', '', '', '', '', '#E8EAF6'],
                ['B', 'Sales Review', 'C', 'Quote', '-->', '', '', '', '', '#FFF9C4'],
                ['C', 'Quote', 'D', 'Approval', '-->', '', '', '', '', '#FFE0B2'],
                ['D', 'Approval', 'E', 'Production', '-->', '', '', '', '', '#B2DFDB'],
                ['E', 'Production', 'F', 'Quality Check', '-->', '', '', '', '', '#F0F4C3'],
                ['F', 'Quality Check', 'G', 'Delivery', '-->', '', '', '', '', '#C8E6C9']
            ],
            onboarding: [
                ['A', 'Offer Accepted', 'B', 'Paperwork', '-->', '', '', '', '', '#E3F2FD'],
                ['B', 'Paperwork', 'C', 'IT Setup', '-->', '', '', '', '', '#F3E5F5'],
                ['B', 'Paperwork', 'D', 'Workspace Prep', '-->', '', '', '', '', '#F3E5F5'],
                ['C', 'IT Setup', 'E', 'First Day', '-->', '', '', '', '', '#FFF9C4'],
                ['D', 'Workspace Prep', 'E', 'First Day', '-->', '', '', '', '', '#FFF9C4'],
                ['E', 'First Day', 'F', 'Training', '-->', '', '', '', '', '#C8E6C9'],
                ['F', 'Training', 'G', 'Active Employee', '-->', '', '', '', '', '#A5D6A7']
            ],
            sales: [
                ['A', 'Lead', 'B', 'Qualified', '-->', '', '', '', '', '#E1F5FE'],
                ['B', 'Qualified', 'C', 'Demo', '-->', '', '', '', '', '#B3E5FC'],
                ['C', 'Demo', 'D', 'Proposal', '-->', '', '', '', '', '#81D4FA'],
                ['D', 'Proposal', 'E', 'Negotiation', '-->', '', '', '', '', '#4FC3F7'],
                ['E', 'Negotiation', 'F', 'Closed Won', '-->|Success|', '', '', '', '', '#C8E6C9'],
                ['E', 'Negotiation', 'G', 'Closed Lost', '-->|Failed|', '', '', '', '', '#FFCDD2']
            ]
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.templates-dropdown')) {
                document.getElementById('templatesMenu').classList.remove('show');
            }
            if (!e.target.closest('.export-dropdown')) {
                document.getElementById('exportMenu').classList.remove('show');
            }
        });

        function toggleTemplates() {
            event.stopPropagation();
            const menu = document.getElementById('templatesMenu');
            menu.classList.toggle('show');
            document.getElementById('exportMenu').classList.remove('show');
        }

        function toggleExport() {
            event.stopPropagation();
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
            document.getElementById('templatesMenu').classList.remove('show');
        }

        function loadTemplate(templateName) {
            if (templates[templateName]) {
                currentData = templates[templateName];
                displayTable(currentData);
                generateMermaidCode();
                updateStatus('dataStatus', 'Template Loaded', false);
                document.getElementById('templatesMenu').classList.remove('show');
            }
        }

        function saveToHistory(code) {
            // Remove any history after current index (for redo functionality)
            codeHistory = codeHistory.slice(0, historyIndex + 1);
            
            // Add new code to history
            codeHistory.push(code);
            
            // Limit history size
            if (codeHistory.length > maxHistory) {
                codeHistory.shift();
            } else {
                historyIndex++;
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                document.getElementById('mermaidCode').value = codeHistory[historyIndex];
                renderDiagram();
            }
        }

        function redo() {
            if (historyIndex < codeHistory.length - 1) {
                historyIndex++;
                document.getElementById('mermaidCode').value = codeHistory[historyIndex];
                renderDiagram();
            }
        }

        // Track code changes for undo/redo
        let typingTimer;
        document.getElementById('mermaidCode').addEventListener('input', function() {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                saveToHistory(this.value);
            }, 1000); // Save after 1 second of no typing
        });

        async function exportDiagram(format) {
            const svg = document.querySelector('#diagram svg');
            if (!svg) {
                alert('Please render a diagram first!');
                return;
            }

            document.getElementById('exportMenu').classList.remove('show');

            if (format === 'svg') {
                // Clone the SVG to avoid modifying the displayed one
                const svgClone = svg.cloneNode(true);
                
                // Ensure proper SVG attributes for standalone viewing
                svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                svgClone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                
                // Get the viewBox or calculate it from width/height
                if (!svgClone.hasAttribute('viewBox')) {
                    const bbox = svg.getBBox();
                    svgClone.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
                }
                
                // Add white background for better viewing
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '100%');
                rect.setAttribute('height', '100%');
                rect.setAttribute('fill', 'white');
                svgClone.insertBefore(rect, svgClone.firstChild);
                
                // Serialize with proper XML declaration
                const svgData = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n' + 
                               new XMLSerializer().serializeToString(svgClone);
                
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mermaid-diagram.svg';
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'png') {
                // Export as PNG
                const svgClone = svg.cloneNode(true);
                
                // Add white background
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '100%');
                rect.setAttribute('height', '100%');
                rect.setAttribute('fill', 'white');
                svgClone.insertBefore(rect, svgClone.firstChild);
                
                const svgData = new XMLSerializer().serializeToString(svgClone);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width * 2; // 2x for better quality
                    canvas.height = img.height * 2;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'mermaid-diagram.png';
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            }
        }

                // Generate a simplified project home HTML file and offer it for download
                function generateLandingPage() {
                    const rawCode = document.getElementById('mermaidCode').value || 'flowchart TD\n    A[Start] --> B[End]';
                    const theme = document.getElementById('theme').value || 'default';
                    //uncomment below to pull the title from the main page
                    //const title = document.querySelector('.header h1')?.textContent || 'Project Diagram';
                    //or specify it here    
                    const title = 'Project Landing Page';

                    // Remove click directives from the mermaid code (we'll handle clicks ourselves)
                    const codeLines = rawCode.split('\n');
                    const filteredLines = codeLines.filter(line => !line.trim().startsWith('click '));
                    const code = filteredLines.join('\n');

                    // Serialize the current maps so the landing page can show tooltips/links/notes
                    const safeUrlJson = JSON.stringify(urlMap || {}).replace(/</g, '\\u003c');
                    const safeNoteJson = JSON.stringify(noteMap || {}).replace(/</g, '\\u003c');
                    const safeTooltipJson = JSON.stringify(tooltipMap || {}).replace(/</g, '\\u003c');

                    const landingParts = [];
                    landingParts.push('<!doctype html>');
                    landingParts.push('<html lang="en">');
                    landingParts.push('<head>');
                    landingParts.push('    <meta charset="utf-8">');
                    landingParts.push('    <meta name="viewport" content="width=device-width, initial-scale=1">');
                    landingParts.push('    <title>' + escapeHtml(title) + '</title>');
                    landingParts.push('    <style>');
                    landingParts.push('        body{font-family: -apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f4f6f8}');
                    landingParts.push('        .hero{background:linear-gradient(90deg,#667eea,#764ba2);color:#fff;padding:28px;text-align:center}');
                    landingParts.push('        .hero h1{margin:0;font-size:28px}');
                    // landingParts.push('        .wrap{max-width:1100px;margin:28px auto;padding:18px}');
                    // landingParts.push('        .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px}');
                    // landingParts.push('        .card{background:#fff;border-radius:10px;padding:18px;box-shadow:0 8px 24px rgba(12,13,14,0.06)}');
                    // landingParts.push('        .side .box{margin-bottom:12px;padding:12px;border-radius:8px;background:#fafafa;border:1px dashed #e6e9ef}');
                    landingParts.push('        .wrap{max-width:1100px;margin:28px auto;padding:18px;height:calc(100vh - 80px);min-height:700px;}'); // Added height/min-height for vertical context
                    landingParts.push('        .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;height:100%;align-items:start;}'); // Set height and align-items
                    landingParts.push('        .card{background:#fff;border-radius:10px;padding:18px;box-shadow:0 8px 24px rgba(12,13,14,0.06);display:flex;flex-direction:column;height:100%;min-height:100%;}'); // Crucial: Flex column layout for main card
                    landingParts.push('        .side{height:100%;}'); // Ensure sidebar container has height
                    landingParts.push('        .side .card{height:100%;display:flex;flex-direction:column;min-height:100%;}'); // Sidebar card needs to be flex column too
                    landingParts.push('        .side .box{margin-bottom:12px;padding:12px;border-radius:8px;background:#fafafa;border:1px dashed #e6e9ef;}'); // Re-added original side box style
                    landingParts.push('        .footer{max-width:1100px;margin:18px auto;text-align:center;color:#6b7280;font-size:13px}');
                    landingParts.push('        .footer{max-width:1100px;margin:18px auto;text-align:center;color:#6b7280;font-size:13px}');
                    landingParts.push('        .node-tooltip{position:fixed;background:rgba(0,0,0,0.85);color:#fff;padding:8px 12px;border-radius:6px;pointer-events:none;z-index:9999;display:none;max-width:320px}');
                    landingParts.push('        .info-panel{position:fixed;right:20px;bottom:20px;max-width:340px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 10px 30px rgba(2,6,23,0.2);display:none}');
                    landingParts.push('        .info-panel.show{display:block}');
                    landingParts.push('        .info-panel h3{margin:0 0 8px 0;font-size:16px}');
                    landingParts.push('        .info-panel a{color:#2563eb}');
                    landingParts.push('        .diagram-container{position:relative;cursor:grab;background:#fff;min-height:400px}');
                    landingParts.push('        .diagram-container.panning{cursor:grabbing}');
                    landingParts.push('        #mermaidDiagramContainer{transform-origin:center center;transition:transform 0.1s ease-out}');
                    // landingParts.push('         .card .box{margin-top:12px;padding:12px;border-radius:8px;background:#fafafa;border:1px dashed #e6e9ef;overflow:hidden}');
                    // landingParts.push('         .card .box.large{height:660px;min-height:300px;overflow:auto}');
                    // landingParts.push('         .card .box.medium{height:220px;min-height:140px;overflow:auto}');
                    // landingParts.push('         .card .box.full{height:520px;min-height:300px;overflow:auto}');
                    landingParts.push('         .card .box{margin-top:12px;padding:12px;border-radius:8px;background:#fafafa;border:1px dashed #e6e9ef;overflow:hidden}');
                    landingParts.push('         .card .box.large{height:660px;min-height:300px;overflow:auto}');
                    landingParts.push('         .card .box.medium{height:220px;min-height:140px;overflow:auto}');
                    landingParts.push('         .card .box.full{height:520px;min-height:300px;overflow:auto;flex-grow:1;display:flex;flex-direction:column;}'); // **UPDATED: Added flex and flex-grow**
                    landingParts.push('    </style>');
                    landingParts.push('    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"><\/script>');
                    landingParts.push('    <script>');
                    landingParts.push('      mermaid.initialize({startOnLoad:false,theme:"' + escapeHtml(theme) + '",securityLevel:"loose"});');
                    landingParts.push('    <\/script>');
                    // Inject the serialized maps
                    landingParts.push('    <script>window.__urlMap = ' + safeUrlJson + '; window.__noteMap = ' + safeNoteJson + '; window.__tooltipMap = ' + safeTooltipJson + '<\/script>');
                    // Behavior script: uses the same logic as renderDiagram from the main app
                    landingParts.push('    <script>');
                    landingParts.push('    let currentZoom = 1, panX = 0, panY = 0, isPanning = false, startPanX = 0, startPanY = 0;');
                    landingParts.push('    ');
                    landingParts.push('    function escapeHtml(s){ return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/\'/g, "&#39;"); }');
                    landingParts.push('    function showTooltip(event, nodeId) {');
                    landingParts.push('      const tooltip = window.__tooltipMap && window.__tooltipMap[nodeId];');
                    landingParts.push('      const note = window.__noteMap && window.__noteMap[nodeId];');
                    landingParts.push('      if(!tooltip && !note) return;');
                    landingParts.push('      const tooltipEl = document.getElementById("nodeTooltip");');
                    landingParts.push('      let html = "";');
                    landingParts.push('      if(tooltip && tooltip.trim()) html += "<div>" + escapeHtml(tooltip) + "</div>";');
                    landingParts.push('      if(note && note.trim()) html += "<div style=\\"margin-top:6px;color:#ffd966;font-size:12px\\">Notes: " + escapeHtml(note) + "</div>";');
                    landingParts.push('      tooltipEl.innerHTML = html;');
                    landingParts.push('      tooltipEl.style.display = "block";');
                    landingParts.push('      updateTooltipPosition(event);');
                    landingParts.push('    }');
                    landingParts.push('    ');
                    landingParts.push('    function updateTooltipPosition(event) {');
                    landingParts.push('      const tooltipEl = document.getElementById("nodeTooltip");');
                    landingParts.push('      if(tooltipEl.style.display === "none") return;');
                    landingParts.push('      tooltipEl.style.left = (event.pageX + 15) + "px";');
                    landingParts.push('      tooltipEl.style.top = (event.pageY + 15) + "px";');
                    landingParts.push('    }');
                    landingParts.push('    ');
                    landingParts.push('    function hideTooltip() {');
                    landingParts.push('      const tooltipEl = document.getElementById("nodeTooltip");');
                    landingParts.push('      tooltipEl.style.display = "none";');
                    landingParts.push('    }');
                    landingParts.push('    ');
                    landingParts.push('    function handleNodeClick(nodeId) {');
                    landingParts.push('      const infoPanel = document.getElementById("infoPanel");');
                    landingParts.push('      const key = (nodeId || "").toString();');
                    landingParts.push('      const keyTrim = key.trim();');
                    landingParts.push('      const url = (window.__urlMap && (window.__urlMap[key] || window.__urlMap[keyTrim]));');
                    landingParts.push('      const note = (window.__noteMap && (window.__noteMap[key] || window.__noteMap[keyTrim]));');
                    landingParts.push('      const noteFallback = note || (window.__tooltipMap && (window.__tooltipMap[key] || window.__tooltipMap[keyTrim]));');
                    landingParts.push('      let html = "<h3>üìç Node: " + escapeHtml(key) + "</h3>";');
                    landingParts.push('      if(url && url !== "#") {');
                    landingParts.push('        html += "<p>üîó <a href=\\"" + escapeHtml(url) + "\\" target=\\"_blank\\">Open link: " + escapeHtml(url) + "</a></p>";');
                    landingParts.push('      } else {');
                    landingParts.push('        html += "<p>No URL available</p>";');
                    landingParts.push('      }');
                    landingParts.push('      if(noteFallback && noteFallback.trim()) { html += "<p><strong>üìù Notes:</strong> " + escapeHtml(noteFallback) + "</p>"; }');
                    landingParts.push('      infoPanel.innerHTML = html;');
                    landingParts.push('      infoPanel.classList.add("show");');
                    landingParts.push('    }');
                    landingParts.push('    ');
                    landingParts.push('    function updateTransform() {');
                    landingParts.push('      const container = document.getElementById("mermaidDiagramContainer");');
                    landingParts.push('      if(container) { container.style.transform = "translate(" + panX + "px," + panY + "px) scale(" + currentZoom + ")"; }');
                    landingParts.push('    }');
                    landingParts.push('    ');
                    landingParts.push('    function setupPan() {');
                    landingParts.push('      const diagram = document.getElementById("diagram");');
                    landingParts.push('      diagram.addEventListener("mousedown", function(e) {');
                    landingParts.push('        if(e.target.closest(".node, g[id^=\\"flowchart-\\"]")) return;');
                    landingParts.push('        isPanning = true;');
                    landingParts.push('        startPanX = e.clientX - panX;');
                    landingParts.push('        startPanY = e.clientY - panY;');
                    landingParts.push('        diagram.classList.add("panning");');
                    landingParts.push('        e.preventDefault();');
                    landingParts.push('      });');
                    landingParts.push('      document.addEventListener("mousemove", function(e) {');
                    landingParts.push('        if(!isPanning) return;');
                    landingParts.push('        panX = e.clientX - startPanX;');
                    landingParts.push('        panY = e.clientY - startPanY;');
                    landingParts.push('        updateTransform();');
                    landingParts.push('      });');
                    landingParts.push('      document.addEventListener("mouseup", function(e) {');
                    landingParts.push('        if(isPanning) {');
                    landingParts.push('          isPanning = false;');
                    landingParts.push('          document.getElementById("diagram").classList.remove("panning");');
                    landingParts.push('        }');
                    landingParts.push('      });');
                    landingParts.push('    }');
                    landingParts.push('    ');
                    landingParts.push('    async function renderDiagram() {');
                    landingParts.push('      const code = ' + JSON.stringify(code) + ';');
                    landingParts.push('      const diagram = document.getElementById("diagram");');
                    landingParts.push('      try {');
                    landingParts.push('        console.log("Maps loaded:", {url: window.__urlMap, note: window.__noteMap, tooltip: window.__tooltipMap});');
                    landingParts.push('        diagram.innerHTML = "<div style=\\"color: #999;\\">Rendering...</div>";');
                    landingParts.push('        const { svg } = await (window.mermaid || mermaid).render("mermaidDiagram", code);');
                    landingParts.push('        diagram.innerHTML = "<div id=\\"mermaidDiagramContainer\\">" + svg + "</div>";');
                    landingParts.push('        const container = document.getElementById("mermaidDiagramContainer");');
                    landingParts.push('        const svgElement = container.querySelector("svg");');
                    landingParts.push('        if(svgElement) {');
                    landingParts.push('          updateTransform();');
                    landingParts.push('          setupPan();');
                    landingParts.push('          const nodes = svgElement.querySelectorAll(".node, g[id^=\\"flowchart-\\"]");');
                    landingParts.push('          console.log("Found " + nodes.length + " nodes");');
                    landingParts.push('          nodes.forEach((node, idx) => {');
                    landingParts.push('            node.style.cursor = "pointer";');
                    landingParts.push('            node.addEventListener("mouseenter", function(e) {');
                    landingParts.push('              let nodeId = this.id;');
                    landingParts.push('              if(!nodeId || nodeId.startsWith("flowchart-")) {');
                    landingParts.push('                const textEl = this.querySelector("text, .nodeLabel");');
                    landingParts.push('                if(textEl) nodeId = textEl.textContent.trim();');
                    landingParts.push('              }');
                    landingParts.push('              if(nodeId && nodeId.includes("-")) {');
                    landingParts.push('                const match = nodeId.match(/flowchart-([A-Z])-/);');
                    landingParts.push('                if(match) nodeId = match[1];');
                    landingParts.push('              }');
                    landingParts.push('              console.log("Hover node " + idx + ":", nodeId, "tooltip:", window.__tooltipMap[nodeId]);');
                    landingParts.push('              showTooltip(e, nodeId);');
                    landingParts.push('            });');
                    landingParts.push('            node.addEventListener("mousemove", function(e) { updateTooltipPosition(e); });');
                    landingParts.push('            node.addEventListener("mouseleave", function(e) { hideTooltip(); });');
                    landingParts.push('            node.addEventListener("click", function(e) {');
                    landingParts.push('              e.preventDefault();');
                    landingParts.push('              e.stopPropagation();');
                    landingParts.push('              let nodeId = this.id;');
                    landingParts.push('              if(!nodeId || nodeId.startsWith("flowchart-")) {');
                    landingParts.push('                const textEl = this.querySelector("text, .nodeLabel");');
                    landingParts.push('                if(textEl) nodeId = textEl.textContent.trim();');
                    landingParts.push('              }');
                    landingParts.push('              if(nodeId && nodeId.includes("-")) {');
                    landingParts.push('                const match = nodeId.match(/flowchart-([A-Z])-/);');
                    landingParts.push('                if(match) nodeId = match[1];');
                    landingParts.push('              }');
                    landingParts.push('              console.log("Click node:", nodeId, "url:", window.__urlMap[nodeId], "note:", window.__noteMap[nodeId]);');
                    landingParts.push('              handleNodeClick(nodeId);');
                    landingParts.push('            });');
                    landingParts.push('          });');
                    landingParts.push('        }');
                    landingParts.push('      } catch(err) {');
                    landingParts.push('        diagram.innerHTML = "<div style=\\"color:red;padding:20px;\\">Error: " + err.message + "</div>";');
                    landingParts.push('      }');
                    landingParts.push('    }');
                    landingParts.push('    ');
                    landingParts.push('    document.addEventListener("DOMContentLoaded", function(){ setTimeout(renderDiagram, 100); });');
                    landingParts.push('    <\/script>');
                    landingParts.push('</head>');
                    landingParts.push('<body>');
                    landingParts.push('    <div class="hero"><h1>' + escapeHtml(title) + '</h1></div>');
                    landingParts.push('    <div class="wrap">');
                    landingParts.push('        <div class="grid">');
                    landingParts.push('            <div class="card">');
                    landingParts.push('                <div id="diagram" class="diagram-container"></div>');
                    landingParts.push('                <div id="infoPanel" class="info-panel"></div>');
                    landingParts.push('                 <div class="box medium"><strong>Notes</strong><div style="margin-top:6px;color:#4b5563">Short notes or summary here.</div></div>'); //insert notes
                                                            //insert iFrame
                    landingParts.push('                 <div id="extraBox" class="box full iframe-container">'); // <-- ADD 'iframe-container' class here
                    landingParts.push('                 <strong>Loop page</strong>');
                    landingParts.push('                 <div style="margin-top:8px">');
                    // Ensure the inner box is still 'full' if needed, but the parent container does the heavy lifting
                    landingParts.push('                 <div class="box full"><iframe src="...URL..." style="width:100%;height:100%;border:0;border-radius:6px"></iframe>');
                    landingParts.push('                 </div>');
                    landingParts.push('                 </div>');
                    landingParts.push('                 </div>'); // End of #extraBox
                    landingParts.push('            <div class="side">');
                    landingParts.push('                <div class="card">');
                    landingParts.push('                    <div class="box"><strong>Overview</strong><div style="margin-top:6px;color:#4b5563">Summary or description for this project can go here.</div></div>');
                    landingParts.push('                    <div class="box"><strong>Links</strong><div style="margin-top:6px;color:#4b5563"><a href="#">Documentation</a></div></div>');
                    landingParts.push('                    <div class="box"><strong>Pull Content</strong><div style="margin-top:6px;color:#9ca3af">Placeholder for SharePoint/Loop embeds</div></div>');
                    landingParts.push('                </div>');
                    landingParts.push('            </div>');
                    landingParts.push('        </div>');
                    landingParts.push('    </div>');
                    landingParts.push('    <div id="nodeTooltip" class="node-tooltip"></div>');
                    landingParts.push('    <div class="footer">Generated by CSV ‚Üí Mermaid interactive editor</div>');
                    landingParts.push('</body>');
                    landingParts.push('</html>');
                    const landing = landingParts.join('\n');

                    const blob = new Blob([landing], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'landing_page.html';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                }

                function escapeHtml(s) {
                        return String(s)
                                .replaceAll('&', '&amp;')
                                .replaceAll('<', '&lt;')
                                .replaceAll('>', '&gt;')
                                .replaceAll('"', '&quot;')
                                .replaceAll("'", '&#39;');
                }

        function loadSampleData() {
            currentData = sampleData;
            displayTable(currentData);
            generateMermaidCode();
            updateStatus('dataStatus', 'Sample Loaded', false);
        }

        function downloadTemplate() {
            // New template includes From_Color and To_Color columns
            const csv = 'From_ID,From_Label,To_ID,To_Label,Connector,Tooltip,URL,notes,From_Color,To_Color\n' +
                'A,Project Start,B,Data Collection,,Kickoff notes,#,,,#D4EDDA\n' +
                'A,Project Start,C,Analysis,-- some text -->,Define requirements,https://example.com/data,Note B,,#FFF3CD\n' +
                'C,Analysis,D,Review,-.->,Check results,https://example.com/analysis,Note C,,\n' +
                'D,Review,E,Final Report,<-->,Final sign-off,https://example.com/report,Note D,,#F8D7DA';

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mermaid_template.csv';
            a.click();
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const csv = event.target.result;
                    parseCSV(csv);
                    updateStatus('dataStatus', 'File Loaded', false);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',');
            currentData = lines.slice(1).map(line => {
                const values = line.split(',');
                return values;
            });
            displayTable(currentData);
            generateMermaidCode();
        }

        function displayTable(data) {
            const table = document.getElementById('csvTable');
            const headers = ['From_ID', 'From_Label', 'To_ID', 'To_Label', 'Connector', 'Tooltip', 'URL', 'notes', 'From_Color', 'To_Color'];
            
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                row.forEach((cell, idx) => {
                    const headerName = headers[idx] || '';
                    if ((headerName === 'From_Color' || headerName === 'To_Color') && cell && cell.trim()) {
                        html += `<td><span style="display:inline-block;width:20px;height:20px;background:${cell};border:1px solid #ccc;border-radius:3px;margin-right:5px;"></span>${cell}</td>`;
                    } else {
                        html += `<td>${cell || ''}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        function generateMermaidCode() {
            const theme = document.getElementById('theme').value;
            const direction = document.getElementById('direction').value;
            let code = `%%{init: {'theme': '${theme}'}}%%\n`;
            code += `flowchart ${direction}\n`;
            urlMap = {};
            noteMap = {};
            tooltipMap = {};
            
            // Collect colors separately for From and To nodes, then merge with clear precedence (To overrides From)
            const fromColors = new Map();
            const toColors = new Map();

            currentData.forEach(row => {
                // Support CSVs with older single Node_Color (at index 8) or new From_Color/To_Color (indexes 8/9)
                const [fromId, fromLabel, toId, toLabel, connector, tooltip, url, notes, fromColor, toColor] = row;

                const conn = connector && connector.trim() ? connector.trim() : '-->';
                code += `    ${fromId}["${fromLabel}"] ${conn} ${toId}["${toLabel}"]\n`;

                // Record colors separately
                if (fromColor && String(fromColor).trim()) {
                    fromColors.set(fromId, String(fromColor).trim());
                }
                if (toColor && String(toColor).trim()) {
                    toColors.set(toId, String(toColor).trim());
                }

                // Backwards compat: if older CSV used a single Node_Color in the 9th column, try to detect it
                // (some older rows may have that value in position 8). If so, apply as To_Color by default.
                if (!toColors.has(toId) && row.length >= 9 && (!toColor || String(toColor).trim() === '')) {
                    const legacyColor = row[8];
                    if (legacyColor && String(legacyColor).trim() && legacyColor.trim().startsWith('#')) {
                        toColors.set(toId, legacyColor.trim());
                    }
                }

                // Associate URL and tooltip with the TARGET node (To_ID)
                if (url && url !== '#') {
                    urlMap[toId] = url; 
                    urlMap[toLabel] = url;
                }
                if (notes && notes.trim()) {
                    noteMap[toId] = notes; 
                    noteMap[toLabel] = notes;
                }
                if (tooltip && tooltip.trim()) {
                    tooltipMap[toId] = tooltip; 
                    tooltipMap[toLabel] = tooltip;
                }
            });

            console.log('Tooltip Map:', tooltipMap);

            // Merge colors into final nodeStyles map. To_Color takes precedence over From_Color.
            const nodeStyles = new Map();
            fromColors.forEach((color, nodeId) => {
                nodeStyles.set(nodeId, `fill:${color},stroke:#333,stroke-width:2px`);
            });
            toColors.forEach((color, nodeId) => {
                // Override any fromColor for this node
                nodeStyles.set(nodeId, `fill:${color},stroke:#333,stroke-width:2px`);
            });

            let styleString = '\n    %% Custom Node Styles\n';
            nodeStyles.forEach((style, nodeId) => {
                styleString += `    style ${nodeId} ${style}\n`;
            });
            code += styleString;

            code += '\n    %% Interactive Elements (associated with target nodes)\n';
            // Track which To_IDs we've already added click handlers for
            const seenToIds = new Set();
            currentData.forEach(row => {
                const [, , toId, , , tooltip, url] = row;
                // Only add a click handler for this To_ID if we haven't seen it yet
                if (!seenToIds.has(toId) && (url && url !== '#' || tooltip)) {
                    seenToIds.add(toId);
                    const tip = tooltip ? tooltip.replace(/"/g, '\\"') : '';
                    const link = url || '#';
                    code += `    click ${toId} "${link}" "${tip}"\n`;
                }
            });

            document.getElementById('mermaidCode').value = code;
            saveToHistory(code); // Save to history when generating
            updateStatus('codeStatus', 'Generated', false);
        }

        async function renderDiagram() {
            const code = document.getElementById('mermaidCode').value;
            const diagram = document.getElementById('diagram');
            
            try {
                diagram.innerHTML = '<div style="color: #999;">Rendering...</div>';
                const { svg } = await window.mermaid.render('mermaidDiagram', code);
                
                // Wrap SVG in a container for pan/zoom
                diagram.innerHTML = `<div id="diagramContainer">${svg}</div>`;
                
                const container = document.getElementById('diagramContainer');
                const svgElement = container.querySelector('svg');
                
                if (svgElement) {
                    // Apply current zoom and pan
                    updateTransform();
                    
                    // Setup pan functionality
                    setupPan();
                    
                    const nodes = svgElement.querySelectorAll('.node, g[id^="flowchart-"]');
                    nodes.forEach(node => {
                        node.style.cursor = 'pointer';
                        
                        // Add hover event for tooltips
                        node.addEventListener('mouseenter', function(e) {
                            let nodeId = this.id;
                            if (!nodeId || nodeId.startsWith('flowchart-')) {
                                const textEl = this.querySelector('text, .nodeLabel');
                                if (textEl) nodeId = textEl.textContent.trim();
                            }
                            if (nodeId && nodeId.includes('-')) {
                                const match = nodeId.match(/flowchart-([A-Z])-/);
                                if (match) nodeId = match[1];
                            }
                            
                            showTooltip(e, nodeId);
                        });
                        
                        node.addEventListener('mousemove', function(e) {
                            updateTooltipPosition(e);
                        });
                        
                        node.addEventListener('mouseleave', function(e) {
                            hideTooltip();
                        });
                        
                        // Keep click handler
                        node.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            let nodeId = this.id;
                            if (!nodeId || nodeId.startsWith('flowchart-')) {
                                const textEl = this.querySelector('text, .nodeLabel');
                                if (textEl) nodeId = textEl.textContent.trim();
                            }
                            if (nodeId && nodeId.includes('-')) {
                                const match = nodeId.match(/flowchart-([A-Z])-/);
                                if (match) nodeId = match[1];
                            }
                            handleNodeClick(nodeId);
                        });
                    });
                }
                updateStatus('codeStatus', 'Rendered', false);
            } catch (err) {
                diagram.innerHTML = `<div style="color: red; padding: 20px;">Error: ${err.message}</div>`;
                updateStatus('codeStatus', 'Error', true);
            }
        }

        function setupPan() {
            const diagram = document.getElementById('diagram');
            const container = document.getElementById('diagramContainer');
            
            diagram.addEventListener('mousedown', function(e) {
                // Don't pan if clicking on a node
                if (e.target.closest('.node, g[id^="flowchart-"]')) return;
                
                isPanning = true;
                startPanX = e.clientX - panX;
                startPanY = e.clientY - panY;
                diagram.classList.add('panning');
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isPanning) return;
                
                panX = e.clientX - startPanX;
                panY = e.clientY - startPanY;
                updateTransform();
            });
            
            document.addEventListener('mouseup', function(e) {
                if (isPanning) {
                    isPanning = false;
                    document.getElementById('diagram').classList.remove('panning');
                }
            });
        }

        function updateTransform() {
            const container = document.getElementById('diagramContainer');
            if (container) {
                container.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
            }
        }

        function showTooltip(event, nodeId) {
            const tooltip = tooltipMap[nodeId];
            if (!tooltip || !tooltip.trim()) return;
            
            const tooltipEl = document.getElementById('nodeTooltip');
            tooltipEl.textContent = tooltip;
            tooltipEl.style.display = 'block';
            updateTooltipPosition(event);
        }

        function updateTooltipPosition(event) {
            const tooltipEl = document.getElementById('nodeTooltip');
            if (tooltipEl.style.display === 'none') return;
            
            tooltipEl.style.left = (event.pageX + 15) + 'px';
            tooltipEl.style.top = (event.pageY + 15) + 'px';
        }

        function hideTooltip() {
            const tooltipEl = document.getElementById('nodeTooltip');
            tooltipEl.style.display = 'none';
        }

        function handleNodeClick(nodeId) {
            const infoPanel = document.getElementById('infoPanel');
            const url = urlMap[nodeId];
            const note = noteMap[nodeId];
            
            let html = `<h3>üìç Node: ${nodeId}</h3>`;
            
            if (url && url !== '#') {
                html += `<p>üîó <a href="${url}" target="_blank">Open link: ${url}</a></p>`;
            } else {
                html += '<p>No URL available</p>';
            }
            
            if (note && note.trim()) {
                html += `<p><strong>üìù Notes:</strong> ${note}</p>`;
            }
            
            infoPanel.innerHTML = html;
            infoPanel.classList.add('show');
        }

        function zoomDiagram(factor) {
            const container = document.getElementById('diagramContainer');
            if (!container) return;
            
            if (factor === 1) {
                currentZoom = 1;
                panX = 0;
                panY = 0;
            } else {
                currentZoom *= factor;
                currentZoom = Math.max(0.5, Math.min(3, currentZoom));
            }
            updateTransform();
        }

        function copyCode() {
            const code = document.getElementById('mermaidCode').value;
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        }

        function updateStatus(elementId, text, isError) {
            const badge = document.getElementById(elementId);
            badge.textContent = text;
            badge.className = 'status-badge' + (isError ? ' error-badge' : '');
        }

        document.getElementById('theme').addEventListener('change', generateMermaidCode);
        document.getElementById('direction').addEventListener('change', generateMermaidCode);

        loadSampleData();
    </script>
</body>
</html>